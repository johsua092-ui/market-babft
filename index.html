<!DOCTYPE html>
<html>
<head>
    <title>OXYX MARKET - FIX</title>
    <style>
        body { background: black; color: white; font-family: Arial; padding: 20px; }
        .box { background: #1a1a2a; border: 2px solid purple; padding: 15px; margin: 10px 0; border-radius: 10px; }
        input, button { padding: 10px; margin: 5px; width: 100%; background: #333; color: white; border: 1px solid purple; border-radius: 5px; }
        button { background: purple; cursor: pointer; font-weight: bold; }
        .device-info { background: #0a0a1a; padding: 10px; border-radius: 5px; font-family: monospace; }
        .stats { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin: 10px 0; }
        .stat-card { background: #2a2a3a; padding: 15px; text-align: center; border-radius: 5px; }
        .stat-number { font-size: 2em; color: gold; font-weight: bold; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { background: purple; padding: 10px; text-align: left; }
        td { padding: 10px; border-bottom: 1px solid #333; }
        .online { color: #00ff00; }
        .offline { color: #666; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>‚ö° OXYX MARKET - BUILD A BOAT ‚ö°</h1>
    
    <!-- DEVICE INFO - PAKE LOCAL STORAGE -->
    <div class="box">
        <h3>üì± DEVICE INFO</h3>
        <div class="device-info">
            <p>Device ID: <span id="deviceId">LOADING...</span></p>
            <p>IP Address: <span id="ipAddress">LOADING...</span></p>
        </div>
    </div>
    
    <!-- STATS -->
    <div class="box">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalMembers">0</div>
                <div>Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="onlineNow">0</div>
                <div>Online</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalBuilds">0</div>
                <div>Builds</div>
            </div>
        </div>
    </div>
    
    <!-- LOGIN -->
    <div class="box">
        <h3>üîê LOGIN</h3>
        <input type="text" id="username" placeholder="Username (member)">
        <button onclick="loginMember()">LOGIN MEMBER</button>
        
        <input type="text" id="adminUser" placeholder="Admin: owner">
        <input type="password" id="adminPass" placeholder="Password">
        <button onclick="loginAdmin()">LOGIN ADMIN</button>
        
        <div id="userInfo" class="hidden" style="margin-top:10px; padding:10px; background:#2a2a3a; border-radius:5px;">
            <p>Logged in as: <span id="displayName"></span></p>
            <button onclick="logout()" style="background:#aa0000;">LOGOUT</button>
        </div>
    </div>
    
    <!-- IP TABLE UNTUK OWNER -->
    <div id="ipTable" class="box hidden">
        <h3>üëë IP TRACKER - MEMBER DATABASE</h3>
        <table>
            <thead>
                <tr>
                    <th>Username</th>
                    <th>IP Address</th>
                    <th>Device ID</th>
                    <th>Last Seen</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="ipTableBody"></tbody>
        </table>
    </div>
    
    <!-- CHAT MOD -->
    <div id="chatSection" class="box hidden">
        <h3>üí¨ MOD CHAT</h3>
        <div id="chatMessages" style="background:#0a0a1a; height:150px; overflow:auto; padding:10px; margin:10px 0;"></div>
        <input type="text" id="chatMsg" placeholder="Type message...">
        <button onclick="sendChat()">SEND</button>
    </div>
    
    <!-- UPLOAD -->
    <div id="uploadSection" class="box hidden">
        <h3>üì§ UPLOAD BUILD</h3>
        <input type="text" id="buildName" placeholder="Build name">
        <input type="number" id="buildPrice" value="0" min="0" placeholder="Price (100+ = premium)">
        <textarea id="buildDesc" rows="3" placeholder="Description"></textarea>
        <input type="file" id="buildFile" accept=".build">
        <button onclick="uploadBuild()">PUBLISH</button>
    </div>
    
    <!-- MARKETPLACE -->
    <div class="box">
        <h3>üè™ MARKETPLACE</h3>
        <div style="display:flex; gap:5px; margin:10px 0; flex-wrap:wrap;">
            <button onclick="filterBuilds('all')">ALL</button>
            <button onclick="filterBuilds('free')">FREE (0)</button>
            <button onclick="filterBuilds('premium')">PREMIUM (100+)</button>
            <button onclick="filterBuilds('my')">MY BUILDS</button>
        </div>
        <div id="marketplace"></div>
    </div>
    
    <script>
        // ========== DATA ==========
        let currentUser = null;
        let currentFilter = 'all';
        let deviceId = 'DEVICE-' + Math.random().toString(36).substring(2, 10).toUpperCase();
        let clientIP = '0.0.0.0';
        
        // Load data dari localStorage
        let members = JSON.parse(localStorage.getItem('members')) || [];
        let builds = JSON.parse(localStorage.getItem('builds')) || [
            {id:1, name:"Dragon Boat", price:0, desc:"Cool dragon boat", file:"dragon.build", seller:"owner"},
            {id:2, name:"Flying Ship", price:150, desc:"Flying ship", file:"flying.build", seller:"mod1"},
            {id:3, name:"Golden Raft", price:200, desc:"Golden raft", file:"golden.build", seller:"member1"}
        ];
        let chats = JSON.parse(localStorage.getItem('chats')) || [];
        
        // ========== DEVICE ID & IP FIX ==========
        document.getElementById('deviceId').innerText = deviceId;
        
        // IP PAKE API ALTERNATIF (PASTI WORK)
        fetch('https://httpbin.org/ip')
            .then(res => res.json())
            .then(data => {
                clientIP = data.origin;
                document.getElementById('ipAddress').innerText = clientIP;
            })
            .catch(() => {
                clientIP = '127.0.0.1';
                document.getElementById('ipAddress').innerText = clientIP;
            });
        
        // ========== FUNCTIONS ==========
        function updateStats() {
            document.getElementById('totalMembers').innerText = members.length;
            document.getElementById('totalBuilds').innerText = builds.length;
            
            let online = members.filter(m => {
                let last = new Date(m.lastSeen).getTime();
                return Date.now() - last < 300000;
            }).length;
            document.getElementById('onlineNow').innerText = online;
        }
        
        function saveMembers() {
            localStorage.setItem('members', JSON.stringify(members));
            updateStats();
            updateIpTable();
        }
        
        // ========== LOGIN MEMBER ==========
        window.loginMember = function() {
            let user = document.getElementById('username').value.trim();
            if (!user) { alert('Masukin nama!'); return; }
            
            let now = new Date().toISOString();
            let existing = members.find(m => m.username === user);
            
            if (existing) {
                existing.lastSeen = now;
                existing.loginCount = (existing.loginCount || 0) + 1;
            } else {
                members.push({
                    username: user,
                    ip: clientIP,
                    deviceId: deviceId,
                    firstSeen: now,
                    lastSeen: now,
                    loginCount: 1
                });
            }
            saveMembers();
            
            currentUser = { username: user, role: 'member' };
            showUserInfo();
            alert('‚úÖ Welcome ' + user);
        };
        
        // ========== LOGIN ADMIN ==========
        window.loginAdmin = function() {
            let user = document.getElementById('adminUser').value.trim();
            let pass = document.getElementById('adminPass').value.trim();
            
            if (user === 'owner' && pass === 'owner_oxyx_2026') {
                currentUser = { username: 'owner', role: 'owner' };
                showUserInfo();
                document.getElementById('ipTable').classList.remove('hidden');
                updateIpTable();
                alert('‚úÖ Welcome OWNER');
            }
            else if ((user === 'mod1' || user === 'mod2') && pass === 'mod123') {
                currentUser = { username: user, role: 'mod' };
                showUserInfo();
                document.getElementById('chatSection').classList.remove('hidden');
                alert('‚úÖ Welcome ' + user);
            }
            else {
                alert('‚ùå Wrong credentials');
            }
        };
        
        function showUserInfo() {
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('displayName').innerText = currentUser.username + ' (' + currentUser.role + ')';
            document.getElementById('uploadSection').classList.remove('hidden');
            if (currentUser.role === 'owner' || currentUser.role === 'mod') {
                document.getElementById('chatSection').classList.remove('hidden');
                displayChat();
            }
        }
        
        window.logout = function() {
            currentUser = null;
            document.getElementById('userInfo').classList.add('hidden');
            document.getElementById('uploadSection').classList.add('hidden');
            document.getElementById('chatSection').classList.add('hidden');
            document.getElementById('ipTable').classList.add('hidden');
            alert('Logged out');
        };
        
        // ========== IP TABLE ==========
        function updateIpTable() {
            let tbody = document.getElementById('ipTableBody');
            if (members.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5">Belum ada member</td></tr>';
                return;
            }
            
            let html = '';
            let fiveMinAgo = Date.now() - 300000;
            
            members.sort((a,b) => new Date(b.lastSeen) - new Date(a.lastSeen)).forEach(m => {
                let isOnline = new Date(m.lastSeen).getTime() > fiveMinAgo;
                let status = isOnline ? '<span class="online">üü¢ ONLINE</span>' : '<span class="offline">‚ö´ OFFLINE</span>';
                html += `
                    <tr>
                        <td><b>${m.username}</b></td>
                        <td>${m.ip || 'Unknown'}</td>
                        <td>${(m.deviceId || '').substring(0,15)}...</td>
                        <td>${new Date(m.lastSeen).toLocaleString()}</td>
                        <td>${status}</td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }
        
        // ========== CHAT ==========
        window.sendChat = function() {
            if (!currentUser || currentUser.role === 'member') {
                alert('Only mods can chat');
                return;
            }
            let msg = document.getElementById('chatMsg').value.trim();
            if (!msg) return;
            
            chats.push({ user: currentUser.username, role: currentUser.role, msg: msg });
            localStorage.setItem('chats', JSON.stringify(chats));
            document.getElementById('chatMsg').value = '';
            displayChat();
        };
        
        function displayChat() {
            let box = document.getElementById('chatMessages');
            let html = '';
            chats.slice(-10).forEach(c => {
                html += `<div><b>${c.user}:</b> ${c.msg}</div>`;
            });
            box.innerHTML = html;
        }
        
        // ========== UPLOAD ==========
        window.uploadBuild = function() {
            if (!currentUser) { alert('Login dulu!'); return; }
            
            let name = document.getElementById('buildName').value.trim();
            let price = parseInt(document.getElementById('buildPrice').value) || 0;
            let desc = document.getElementById('buildDesc').value.trim();
            let file = document.getElementById('buildFile').files[0];
            
            if (!name || !desc || !file) { alert('Isi semua!'); return; }
            
            builds.push({
                id: Date.now(),
                name: name,
                price: price,
                desc: desc,
                file: file.name,
                seller: currentUser.username
            });
            localStorage.setItem('builds', JSON.stringify(builds));
            alert('‚úÖ Upload berhasil');
            displayBuilds();
            updateStats();
        };
        
        // ========== DELETE ==========
        window.deleteBuild = function(id, seller) {
            if (!currentUser) { alert('Login dulu!'); return; }
            if (currentUser.role === 'owner' || currentUser.role === 'mod' || currentUser.username === seller) {
                builds = builds.filter(b => b.id !== id);
                localStorage.setItem('builds', JSON.stringify(builds));
                displayBuilds();
                updateStats();
                alert('‚úÖ Build dihapus');
            } else {
                alert('‚ùå Ga boleh hapus punya orang');
            }
        };
        
        window.downloadBuild = function(file) {
            alert('üì• Download ' + file);
        };
        
        // ========== FILTER ==========
        window.filterBuilds = function(filter) {
            currentFilter = filter;
            displayBuilds();
        };
        
        function displayBuilds() {
            let filtered = builds;
            
            if (currentFilter === 'free') {
                filtered = builds.filter(b => b.price === 0);
            } else if (currentFilter === 'premium') {
                filtered = builds.filter(b => b.price >= 100);
            } else if (currentFilter === 'my') {
                if (!currentUser) {
                    document.getElementById('marketplace').innerHTML = '<p>Login untuk lihat buildmu</p>';
                    return;
                }
                filtered = builds.filter(b => b.seller === currentUser.username);
            }
            
            if (filtered.length === 0) {
                document.getElementById('marketplace').innerHTML = '<p>No builds</p>';
                return;
            }
            
            let html = '';
            filtered.reverse().forEach(b => {
                let canDelete = currentUser && (currentUser.role === 'owner' || currentUser.role === 'mod' || currentUser.username === b.seller);
                html += `
                    <div style="border:1px solid purple; margin:10px 0; padding:10px; border-radius:5px; ${b.price>=100?'border-color:gold;':''}">
                        <h3>${b.name}</h3>
                        <p>üí∞ ${b.price} Robux</p>
                        <p>${b.desc}</p>
                        <p>üì¶ ${b.file}</p>
                        <p>Seller: ${b.seller}</p>
                        <button onclick="downloadBuild('${b.file}')">‚¨áÔ∏è DOWNLOAD</button>
                        ${canDelete ? `<button onclick="deleteBuild(${b.id}, '${b.seller}')" style="background:#aa0000;">üóëÔ∏è DELETE</button>` : ''}
                    </div>
                `;
            });
            document.getElementById('marketplace').innerHTML = html;
        }
        
        // ========== INIT ==========
        updateStats();
        displayBuilds();
        setInterval(updateStats, 5000);
    </script>
</body>
</html>
