<!DOCTYPE html>
<html>
<head>
    <title>OXYX MARKET | FIXED EDITION</title>
    <style>
        /* Style tetap sama seperti milik Tuan agar UI tidak berubah */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Arial,sans-serif; }
        body { background:#0a0a0a; color:white; padding:20px; }
        .container { max-width:1400px; margin:0 auto; }
        h1 { font-size:4em; text-align:center; color:#b300ff; text-shadow:3px 3px 0 #ff00ff,-3px -3px 0 #00ffff; margin-bottom:30px; }
        .card { background:#1a1a2a; border:2px solid #b300ff; border-radius:15px; padding:20px; margin-bottom:20px; }
        .stats { display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin:20px 0; }
        .stat-card { background:#2a0a3a; border:2px solid gold; border-radius:10px; padding:15px; text-align:center; }
        .stat-value { font-size:2.5em; color:gold; }
        .online-dot { display:inline-block; width:10px; height:10px; background:#00ff00; border-radius:50%; animation:pulse 2s infinite; }
        @keyframes pulse { 0%{opacity:1} 50%{opacity:0.5;transform:scale(1.3)} }
        #deviceInfoSection { display:none; }
        .admin-device { background:#0a0a1a; padding:10px; border-radius:5px; font-family:monospace; }
        .device-id { color:#00ff00; }
        .login-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        input, textarea { width:100%; padding:12px; margin:8px 0; background:#2a2a3a; border:2px solid #b300ff; border-radius:5px; color:white; }
        button { width:100%; padding:15px; background:#b300ff; border:none; border-radius:5px; color:white; font-weight:bold; cursor:pointer; }
        button:hover { background:#d400ff; }
        .ip-table { width:100%; border-collapse:collapse; margin-top:15px; }
        .ip-table th { background:#b300ff; padding:12px; text-align:left; }
        .ip-table td { padding:10px; border-bottom:1px solid #333; }
        .online { color:#00ff00; }
        .offline { color:#666; }
        .session-warning { background:#aa0000; padding:15px; border-radius:5px; text-align:center; margin-bottom: 10px; }
        .hidden { display:none !important; }
        .footer { text-align:center; color:#666; margin-top:30px; }
        .dev-tools { background:#0a0a1a; border:2px solid #ff6600; border-radius:10px; padding:15px; margin:10px 0; }
        .dev-console { height:200px; overflow-y:auto; background:#000; padding:10px; font-family:monospace; font-size:12px; color:#00ff00; }
        .reset-section { background:#2a0a0a; border:2px solid #ff0000; border-radius:10px; padding:15px; margin:10px 0; }
        .warning-text { color:#ff6600; font-weight:bold; }
        .success-text { color:#00ff00; font-weight:bold; }
        .error-text { color:#ff0000; font-weight:bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ö° OXYX MARKET ‚ö°</h1>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalMembers">0</div>
                <div>Total Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="onlineNow">0</div>
                <div><span class="online-dot"></span> Online</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalBuilds">0</div>
                <div>Total Builds</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalIPs">0</div>
                <div>Unique IPs</div>
            </div>
        </div>

        <div id="deviceInfoSection" class="card">
            <h2>üì± DEVICE INFO</h2>
            <div class="admin-device">
                <p>Device ID: <span class="device-id" id="deviceId">Loading...</span></p>
            </div>
        </div>

        <div class="card">
            <h2>üîê LOGIN</h2>
            <div id="sessionWarning" class="session-warning hidden">
                ‚ö†Ô∏è Akun aktif di device lain! 
                <button onclick="forceUnbind()" style="width:auto; padding:5px 10px; background:white; color:black; font-size:12px;">FORCE UNBIND (OWNER ONLY)</button>
            </div>
            <div class="login-grid" id="loginForm">
                <div>
                    <h3>üë§ MEMBER</h3>
                    <input type="text" id="memberUsername" placeholder="Username">
                    <button onclick="loginMember()">LOGIN MEMBER</button>
                </div>
                <div>
                    <h3>üëë ADMIN</h3>
                    <input type="text" id="adminUser" placeholder="Username">
                    <input type="password" id="adminPass" placeholder="Password">
                    <button onclick="loginAdmin()">LOGIN ADMIN</button>
                </div>
            </div>
            <div id="userInfo" class="hidden" style="margin-top:20px; padding:15px; background:#2a0a3a; border-radius:10px;">
                <p>Logged in as: <span id="displayName" style="font-weight:bold; color:gold;"></span></p>
                <button onclick="logout()" style="background:#aa0000; margin-top:10px;">LOGOUT</button>
            </div>
        </div>

        <div id="devToolsSection" class="card hidden">
            <h2>üõ†Ô∏è ADVANCED DEV TOOLS (OWNER ONLY)</h2>
            <div class="dev-tools">
                <h3>System Monitor</h3>
                <div class="dev-console" id="devConsole"></div>
                <button onclick="clearDevConsole()" style="width:auto; padding:5px 10px; margin:5px;">Clear Console</button>
                <button onclick="runSystemDiagnostics()" style="width:auto; padding:5px 10px; margin:5px;">Run Diagnostics</button>
                <button onclick="exportSystemLogs()" style="width:auto; padding:5px 10px; margin:5px;">Export Logs</button>
            </div>
            
            <div class="dev-tools">
                <h3>Database Management</h3>
                <button onclick="backupDatabase()" style="width:auto; padding:5px 10px; margin:5px;">Backup Database</button>
                <button onclick="optimizeDatabase()" style="width:auto; padding:5px 10px; margin:5px;">Optimize DB</button>
                <button onclick="clearCache()" style="width:auto; padding:5px 10px; margin:5px;">Clear Cache</button>
            </div>

            <div class="dev-tools">
                <h3>Security Tools</h3>
                <button onclick="scanSecurity()" style="width:auto; padding:5px 10px; margin:5px;">Security Scan</button>
                <button onclick="generateSecurityReport()" style="width:auto; padding:5px 10px; margin:5px;">Security Report</button>
                <button onclick="auditUserActivity()" style="width:auto; padding:5px 10px; margin:5px;">Audit Activity</button>
            </div>
        </div>

        <div id="passwordResetSection" class="card hidden">
            <h2>üîë MODERATOR MANAGEMENT (OWNER ONLY)</h2>
            <div class="reset-section">
                <h3 class="warning-text">‚ö†Ô∏è Reset Moderator Password</h3>
                <p style="color:#ccc; margin:10px 0;">This action will reset the selected moderator's password and WHID.</p>
                <select id="modSelect" style="width:100%; padding:10px; margin:10px 0; background:#2a2a3a; border:2px solid #ff6600; color:white;">
                    <option value="">Select Moderator</option>
                    <option value="helper_tester">helper_tester</option>
                    <option value="sigma">sigma</option>
                </select>
                <input type="password" id="newModPassword" placeholder="New Password (min 8 chars)" style="border-color:#ff6600;">
                <input type="text" id="newModWhid" placeholder="New WHID (optional)" style="border-color:#ff6600;">
                <button onclick="resetModeratorCredentials()" style="background:#ff6600; margin-top:10px;">RESET CREDENTIALS</button>
                
                <div style="margin-top:20px; padding:10px; background:#1a1a1a; border-radius:5px;">
                    <h4 class="warning-text">Current Moderators:</h4>
                    <div id="modList" style="font-family:monospace; color:#00ff00; margin-top:10px;"></div>
                </div>
            </div>
        </div>

        <div id="ipTableSection" class="card hidden">
            <h2>üëë IP TRACKER (OWNER ONLY)</h2>
            <table class="ip-table">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Device ID</th>
                        <th>Last Seen</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="ipTableBody"></tbody>
            </table>
        </div>

        <div id="chatSection" class="card hidden">
            <h2>üí¨ MOD CHAT</h2>
            <div id="chatMessages" style="height:150px; overflow:auto; background:#0a0a1a; padding:10px; margin:10px 0;"></div>
            <input type="text" id="chatMsg" placeholder="Type message...">
            <button onclick="sendChat()">SEND</button>
        </div>

        <div id="uploadSection" class="card hidden">
            <h2>üì§ UPLOAD BUILD</h2>
            <input type="text" id="buildName" placeholder="Build name">
            <input type="number" id="buildPrice" min="0" value="0" placeholder="Price (100+ = premium)">
            <textarea id="buildDesc" rows="3" placeholder="Description"></textarea>
            <input type="file" id="buildFile" accept=".build">
            <button onclick="uploadBuild()">PUBLISH BUILD</button>
        </div>

        <div class="card">
            <h2>üè™ MARKETPLACE</h2>
            <div style="display:flex; gap:10px; margin:15px 0; flex-wrap:wrap;">
                <button onclick="filterBuilds('all')">üìã ALL</button>
                <button onclick="filterBuilds('free')">üÜì FREE</button>
                <button onclick="filterBuilds('premium')">üíé PREMIUM</button>
                <button onclick="filterBuilds('my')">üë§ MY BUILDS</button>
            </div>
            <div id="marketplace" style="display:grid; grid-template-columns:repeat(auto-fill,minmax(250px,1fr)); gap:15px;"></div>
        </div>

        <div class="footer">OXYX MARKET ‚Ä¢ Build A Boat Only</div>
    </div>

    <script>
        // ========== OBFUSCATED CORE SYSTEM ==========
        const _0x4a2b = ['oxy_device_id', 'activeSessions', 'members', 'builds', 'chats', 'moderatorCredentials'];
        const _0x1c3d = (function() {
            let _0x5e7f = true;
            return function(_0x8g9h, _0x2i3j) {
                const _0x4k5l = _0x5e7f ? function() {
                    if (_0x2i3j) {
                        const _0x6m7n = _0x2i3j.apply(_0x8g9h, arguments);
                        _0x2i3j = null;
                        return _0x6m7n;
                    }
                } : function() {};
                _0x5e7f = false;
                return _0x4k5l;
            };
        })();

        // ========== ENHANCED DATA & SETUP ==========
        let currentUser = null;
        let deviceId = localStorage.getItem(_0x4a2b[0]) || 'OXYX-' + Math.random().toString(36).substring(2,10).toUpperCase();
        localStorage.setItem(_0x4a2b[0], deviceId);
        
        let activeSessions = JSON.parse(localStorage.getItem(_0x4a2b[1])) || {};
        let members = JSON.parse(localStorage.getItem(_0x4a2b[2])) || [];
        let builds = JSON.parse(localStorage.getItem(_0x4a2b[3])) || [];
        let chats = JSON.parse(localStorage.getItem(_0x4a2b[4])) || [];
        let moderatorCredentials = JSON.parse(localStorage.getItem(_0x4a2b[5])) || {
            'helper_tester': { password: 'huwydhdjsiqo', whid: 'WHID_001', lastReset: null },
            'sigma': { password: 'uBwbONeqIwYQ97', whid: 'WHID_002', lastReset: null }
        };

        document.getElementById('deviceId').innerText = deviceId;

        // ========== ENHANCED SECURITY SYSTEM ==========
        const SecurityManager = {
            _key: 'OXYX_SEC_' + Date.now(),
            _attempts: {},
            _blocked: new Set(),
            
            validateAccess: function(user, action) {
                const timestamp = Date.now();
                if (!this._attempts[user]) this._attempts[user] = [];
                this._attempts[user].push({ action, timestamp });
                
                // Clean old attempts (older than 5 minutes)
                this._attempts[user] = this._attempts[user].filter(a => timestamp - a.timestamp < 300000);
                
                if (this._attempts[user].length > 10) {
                    this._blocked.add(user);
                    this.logToDevConsole(`üö® SECURITY: User ${user} blocked for excessive attempts`);
                    return false;
                }
                return !this._blocked.has(user);
            },
            
            logToDevConsole: function(message) {
                const console = document.getElementById('devConsole');
                if (console) {
                    const timestamp = new Date().toLocaleTimeString();
                    console.innerHTML += `<div>[${timestamp}] ${message}</div>`;
                    console.scrollTop = console.scrollHeight;
                }
            },
            
            encrypt: function(data) {
                return btoa(JSON.stringify(data));
            },
            
            decrypt: function(data) {
                try {
                    return JSON.parse(atob(data));
                } catch(e) {
                    return null;
                }
            }
        };

        // ========== ENHANCED CORE FUNCTIONS ==========
        window.forceUnbind = function() {
            if (!currentUser || currentUser.role !== 'owner') {
                SecurityManager.logToDevConsole('üö® UNAUTHORIZED: Force unbind attempt by non-owner');
                return alert("‚ùå Access Denied: Owner Only!");
            }
            
            let user = document.getElementById('adminUser').value || document.getElementById('memberUsername').value;
            if(!user) return alert("Masukkan username di kotak login dulu!");
            
            delete activeSessions[user];
            localStorage.setItem(_0x4a2b[1], JSON.stringify(activeSessions));
            document.getElementById('sessionWarning').classList.add('hidden');
            SecurityManager.logToDevConsole(`‚úÖ ADMIN: Session reset for user ${user}`);
            alert("‚úÖ Sesi " + user + " telah di-reset! Silahkan login kembali.");
        };

        window.loginMember = function() {
            let user = document.getElementById('memberUsername').value.trim();
            if (!user) return alert('Tolong beri nama buildnya!');
            
            if (!SecurityManager.validateAccess(user, 'login')) {
                return alert('‚ùå Access blocked due to suspicious activity!');
            }
            
            if (activeSessions[user] && activeSessions[user] !== deviceId) {
                document.getElementById('sessionWarning').classList.remove('hidden');
                return;
            }
            loginFinalize(user, 'member');
        };

        window.loginAdmin = function() {
            let user = document.getElementById('adminUser').value.trim();
            let pass = document.getElementById('adminPass').value.trim();
            
            if (!SecurityManager.validateAccess(user, 'admin_login')) {
                return alert('‚ùå Access blocked due to suspicious activity!');
            }
            
            if (activeSessions[user] && activeSessions[user] !== deviceId) {
                document.getElementById('sessionWarning').classList.remove('hidden');
                return;
            }

            if (user === 'znyt' && pass === 'Root!Delta_7KpZ') {
                loginFinalize(user, 'owner');
            } else if (moderatorCredentials[user] && moderatorCredentials[user].password === pass) {
                loginFinalize(user, 'mod');
            } else {
                SecurityManager.logToDevConsole(`üö® FAILED LOGIN: ${user} with invalid credentials`);
                alert('‚ùå Password Salah!');
            }
        };

        function loginFinalize(user, role) {
            currentUser = { username: user, role: role, loginTime: Date.now() };
            activeSessions[user] = deviceId;
            localStorage.setItem(_0x4a2b[1], JSON.stringify(activeSessions));

            // Enhanced member tracking
            let now = new Date().toISOString();
            let idx = members.findIndex(m => m.username === user);
            if(idx > -1) {
                members[idx].lastSeen = now;
                members[idx].loginCount = (members[idx].loginCount || 0) + 1;
            } else {
                members.push({
                    username: user, 
                    deviceId: deviceId, 
                    lastSeen: now,
                    loginCount: 1,
                    role: role
                });
            }
            localStorage.setItem(_0x4a2b[2], JSON.stringify(members));
            
            SecurityManager.logToDevConsole(`‚úÖ LOGIN: ${user} as ${role.toUpperCase()}`);
            showUserInfo();
            alert('‚úÖ Login Berhasil sebagai ' + role.toUpperCase());
        }

        function showUserInfo() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('sessionWarning').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('displayName').innerText = currentUser.username + ' (' + currentUser.role + ')';
            document.getElementById('uploadSection').classList.remove('hidden');
            document.getElementById('deviceInfoSection').style.display = 'block';

            if (currentUser.role === 'owner') {
                document.getElementById('ipTableSection').classList.remove('hidden');
                document.getElementById('devToolsSection').classList.remove('hidden');
                document.getElementById('passwordResetSection').classList.remove('hidden');
                updateIpTable();
                updateModeratorList();
                SecurityManager.logToDevConsole('üîß OWNER: All admin panels activated');
            }

            if (currentUser.role === 'owner' || currentUser.role === 'mod') {
                document.getElementById('chatSection').classList.remove('hidden');
                displayChat();
            }
        }

        window.logout = function() {
            if (currentUser) {
                SecurityManager.logToDevConsole(`üì§ LOGOUT: ${currentUser.username}`);
                delete activeSessions[currentUser.username];
                localStorage.setItem(_0x4a2b[1], JSON.stringify(activeSessions));
            }
            location.reload();
        };

        // ========== ENHANCED DEV TOOLS ==========
        window.clearDevConsole = function() {
            if (currentUser?.role !== 'owner') return;
            document.getElementById('devConsole').innerHTML = '';
        };

        window.runSystemDiagnostics = function() {
            if (currentUser?.role !== 'owner') return;
            SecurityManager.logToDevConsole('üîç DIAGNOSTICS: Starting system scan...');
            
            setTimeout(() => {
                SecurityManager.logToDevConsole(`üìä Memory Usage: ${(JSON.stringify(localStorage).length / 1024).toFixed(2)} KB`);
                SecurityManager.logToDevConsole(`üë• Active Sessions: ${Object.keys(activeSessions).length}`);
                SecurityManager.logToDevConsole(`üèóÔ∏è Total Builds: ${builds.length}`);
                SecurityManager.logToDevConsole(`üí¨ Chat Messages: ${chats.length}`);
                SecurityManager.logToDevConsole(`üîí Security Status: ACTIVE`);
                SecurityManager.logToDevConsole('‚úÖ DIAGNOSTICS: System scan completed');
            }, 1000);
        };

        window.exportSystemLogs = function() {
            if (currentUser?.role !== 'owner') return;
            const logs = document.getElementById('devConsole').innerText;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oxyx_logs_${Date.now()}.txt`;
            a.click();
            SecurityManager.logToDevConsole('üìÅ EXPORT: System logs exported');
        };

        window.backupDatabase = function() {
            if (currentUser?.role !== 'owner') return;
            const backup = {
                members, builds, chats, moderatorCredentials,
                timestamp: Date.now(),
                version: '2.0'
            };
            const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `oxyx_backup_${Date.now()}.json`;
            a.click();
            SecurityManager.logToDevConsole('üíæ BACKUP: Database backup created');
        };

        window.optimizeDatabase = function() {
            if (currentUser?.role !== 'owner') return;
            SecurityManager.logToDevConsole('‚ö° OPTIMIZE: Starting database optimization...');
            
            // Remove old inactive sessions
            const now = Date.now();
            Object.keys(activeSessions).forEach(user => {
                const member = members.find(m => m.username === user);
                if (member && now - new Date(member.lastSeen).getTime() > 86400000) { // 24 hours
                    delete activeSessions[user];
                }
            });
            
            localStorage.setItem(_0x4a2b[1], JSON.stringify(activeSessions));
            SecurityManager.logToDevConsole('‚úÖ OPTIMIZE: Database optimization completed');
        };

        window.clearCache = function() {
            if (currentUser?.role !== 'owner') return;
            SecurityManager._attempts = {};
            SecurityManager._blocked.clear();
            SecurityManager.logToDevConsole('üßπ CACHE: Security cache cleared');
        };

        window.scanSecurity = function() {
            if (currentUser?.role !== 'owner') return;
            SecurityManager.logToDevConsole('üõ°Ô∏è SECURITY: Starting security scan...');
            
            setTimeout(() => {
                const suspiciousUsers = Object.keys(SecurityManager._attempts).filter(u => 
                    SecurityManager._attempts[u].length > 5
                );
                
                SecurityManager.logToDevConsole(`üîç Suspicious Users: ${suspiciousUsers.length}`);
                SecurityManager.logToDevConsole(`üö´ Blocked Users: ${SecurityManager._blocked.size}`);
                SecurityManager.logToDevConsole(`üîê Moderator Accounts: ${Object.keys(moderatorCredentials).length}`);
                SecurityManager.logToDevConsole('‚úÖ SECURITY: Scan completed - System secure');
            }, 1500);
        };

        window.generateSecurityReport = function() {
            if (currentUser?.role !== 'owner') return;
            const report = {
                timestamp: new Date().toISOString(),
                totalUsers: members.length,
                activeUsers: Object.keys(activeSessions).length,
                suspiciousActivity: Object.keys(SecurityManager._attempts).length,
                blockedUsers: Array.from(SecurityManager._blocked),
                moderators: Object.keys(moderatorCredentials)
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `security_report_${Date.now()}.json`;
            a.click();
            SecurityManager.logToDevConsole('üìã REPORT: Security report generated');
        };

        window.auditUserActivity = function() {
            if (currentUser?.role !== 'owner') return;
            SecurityManager.logToDevConsole('üîç AUDIT: Analyzing user activity...');
            
            setTimeout(() => {
                members.forEach(member => {
                    const lastSeen = new Date(member.lastSeen);
                    const daysSince = Math.floor((Date.now() - lastSeen.getTime()) / 86400000);
                    SecurityManager.logToDevConsole(`üë§ ${member.username}: Last seen ${daysSince} days ago (${member.loginCount || 1} logins)`);
                });
                SecurityManager.logToDevConsole('‚úÖ AUDIT: User activity analysis completed');
            }, 1000);
        };

        // ========== MODERATOR MANAGEMENT ==========
        window.resetModeratorCredentials = function() {
            if (currentUser?.role !== 'owner') {
                return alert("‚ùå Access Denied: Owner Only!");
            }
            
            const modUsername = document.getElementById('modSelect').value;
            const newPassword = document.getElementById('newModPassword').value.trim();
            const newWhid = document.getElementById('newModWhid').value.trim();
            
            if (!modUsername) return alert("‚ùå Please select a moderator!");
            if (!newPassword || newPassword.length < 8) return alert("‚ùå Password must be at least 8 characters!");
            
            if (!moderatorCredentials[modUsername]) {
                return alert("‚ùå Moderator not found!");
            }
            
            // Update credentials
            moderatorCredentials[modUsername].password = newPassword;
            if (newWhid) moderatorCredentials[modUsername].whid = newWhid;
            moderatorCredentials[modUsername].lastReset = new Date().toISOString();
            
            // Force logout if moderator is currently logged in
            if (activeSessions[modUsername]) {
                delete activeSessions[modUsername];
                localStorage.setItem(_0x4a2b[1], JSON.stringify(activeSessions));
            }
            
            localStorage.setItem(_0x4a2b[5], JSON.stringify(moderatorCredentials));
            
            SecurityManager.logToDevConsole(`üîë RESET: Credentials updated for moderator ${modUsername}`);
            
            // Clear form
            document.getElementById('newModPassword').value = '';
            document.getElementById('newModWhid').value = '';
            document.getElementById('modSelect').value = '';
            
            updateModeratorList();
            alert(`‚úÖ Credentials reset successfully for ${modUsername}!\nModerator has been logged out and must use new credentials.`);
        };

        function updateModeratorList() {
            const modList = document.getElementById('modList');
            if (!modList) return;
            
            let html = '';
            Object.keys(moderatorCredentials).forEach(mod => {
                const cred = moderatorCredentials[mod];
                const lastReset = cred.lastReset ? new Date(cred.lastReset).toLocaleString() : 'Never';
                const isOnline = activeSessions[mod] ? 'üü¢ ONLINE' : 'üî¥ OFFLINE';
                html += `<div style="margin:5px 0; padding:5px; background:#2a2a2a; border-radius:3px;">
                    <strong>${mod}</strong> - ${isOnline}<br>
                    <small>WHID: ${cred.whid} | Last Reset: ${lastReset}</small>
                </div>`;
            });
            modList.innerHTML = html;
        }

        // ========== MARKETPLACE & UPLOAD (Enhanced) ==========
        window.uploadBuild = function() {
            if (!currentUser) return alert('Login dulu!');
            
            const file = document.getElementById('buildFile').files[0];
            const name = document.getElementById('buildName').value.trim();
            const desc = document.getElementById('buildDesc').value.trim();
            const typeInput = document.getElementById('buildPrice').value;
            const price = parseInt(typeInput);

            if (!file) return alert("tolong upload file build anda");
            if (!desc) return alert("tolong tulis deskripsi build");
            if (!typeInput || isNaN(price)) return alert("tolong pilih type build nya");
            if (!name) return alert("tolong beri nama buildnya");

            const buildId = Date.now();
            builds.push({ 
                id: buildId, 
                name: name, 
                price: price, 
                desc: desc, 
                file: file.name, 
                seller: currentUser.username,
                type: price >= 100 ? 'premium' : 'non-premium',
                uploadDate: new Date().toISOString(),
                downloads: 0
            });
            
            localStorage.setItem(_0x4a2b[3], JSON.stringify(builds));
            SecurityManager.logToDevConsole(`üì§ BUILD: ${name} uploaded by ${currentUser.username} (${price} Robux)`);
            
            let targetMarket = (price >= 100) ? "Premium Marketplace" : "Non-Premium Marketplace";
            alert(`‚úÖ build telah sukses di publish dan mengarah marketplace untuk yang ${targetMarket}`);
            displayBuilds();
            updateStats();
        };

        window.displayBuilds = function(filter = 'all') {
            let container = document.getElementById('marketplace');
            let filtered = builds;
            
            if (filter === 'free') filtered = builds.filter(b => b.price === 0);
            if (filter === 'premium') filtered = builds.filter(b => b.price >= 100);
            if (filter === 'my') filtered = builds.filter(b => b.seller === currentUser?.username);
            
            container.innerHTML = filtered.length ? '' : '<p>Belum ada build.</p>';
            
            filtered.reverse().forEach(b => {
                let card = document.createElement('div');
                card.style = `background:#2a2a3a; border:2px solid ${b.price>=100?'gold':'#b300ff'}; border-radius:10px; padding:15px;`;
                card.innerHTML = `
                    <h3>${b.name} ${b.price>=100?'üíé':''}</h3>
                    <p style="color:gold;">üí∞ ${b.price} Robux</p>
                    <p style="font-size:12px; color:#aaa;">${b.desc}</p>
                    <p style="font-size:10px; color:#666;">Seller: ${b.seller}</p>
                    <p style="font-size:10px; color:#666;">Downloads: ${b.downloads || 0}</p>
                    <button style="margin-top:10px; background:#00aa00;" onclick="downloadBuild(${b.id})">‚¨áÔ∏è DOWNLOAD</button>
                `;
                container.appendChild(card);
            });
        };

        window.downloadBuild = function(buildId) {
            const build = builds.find(b => b.id === buildId);
            if (build) {
                build.downloads = (build.downloads || 0) + 1;
                localStorage.setItem(_0x4a2b[3], JSON.stringify(builds));
                SecurityManager.logToDevConsole(`‚¨áÔ∏è DOWNLOAD: ${build.name} by ${currentUser?.username || 'Anonymous'}`);
                alert(`Downloading ${build.file}...`);
                displayBuilds();
            }
        };

        window.filterBuilds = (f) => displayBuilds(f);

        function updateIpTable() {
            let tbody = document.getElementById('ipTableBody');
            tbody.innerHTML = members.map(m => `
                <tr>
                    <td><b>${m.username}</b> ${m.role ? `(${m.role})` : ''}</td>
                    <td>${m.deviceId.substring(0,10)}...</td>
                    <td>${new Date(m.lastSeen).toLocaleString()}</td>
                    <td class="online">‚óè ACTIVE (${m.loginCount || 1} logins)</td>
                </tr>
            `).join('');
        }

        function updateStats() {
            document.getElementById('totalMembers').innerText = members.length;
            document.getElementById('totalBuilds').innerText = builds.length;
            document.getElementById('onlineNow').innerText = Object.keys(activeSessions).length;
            document.getElementById('totalIPs').innerText = [...new Set(members.map(m => m.deviceId))].length;
        }

        function displayChat() {
            document.getElementById('chatMessages').innerHTML = chats.map(c => 
                `<div style="margin-bottom:5px;">
                    <span style="color:${c.role==='owner'?'gold':'#00ff00'}">[${c.user}]:</span> ${c.msg}
                    <small style="color:#666; margin-left:10px;">${new Date(c.timestamp || Date.now()).toLocaleTimeString()}</small>
                </div>`
            ).join('');
        }

        window.sendChat = function() {
            let m = document.getElementById('chatMsg').value;
            if(!m) return;
            
            chats.push({
                user: currentUser.username, 
                role: currentUser.role, 
                msg: m,
                timestamp: Date.now()
            });
            localStorage.setItem(_0x4a2b[4], JSON.stringify(chats));
            document.getElementById('chatMsg').value = '';
            displayChat();
            SecurityManager.logToDevConsole(`üí¨ CHAT: ${currentUser.username}: ${m.substring(0, 50)}...`);
        };

        // ========== INITIALIZATION ==========
        (function initializeSystem() {
            updateStats();
            displayBuilds();
            
            // Auto-save system state every 30 seconds
            setInterval(() => {
                if (currentUser) {
                    localStorage.setItem(_0x4a2b[1], JSON.stringify(activeSessions));
                    localStorage.setItem(_0x4a2b[2], JSON.stringify(members));
                    localStorage.setItem(_0x4a2b[5], JSON.stringify(moderatorCredentials));
                }
            }, 30000);
            
            SecurityManager.logToDevConsole('üöÄ SYSTEM: OXYX Market initialized successfully');
        })();
    </script>
</body>
</html>
