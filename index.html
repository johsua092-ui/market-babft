<!DOCTYPE html>
<html>
<head>
    <title>OXYX Market - FULL</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: black; color: white; font-family: Arial; padding: 20px; }
        .box { background: #1a1a2a; border: 2px solid purple; border-radius: 10px; padding: 15px; margin: 10px 0; }
        input, button, textarea { padding: 10px; margin: 5px; background: #333; color: white; border: 1px solid purple; border-radius: 5px; }
        button { background: purple; cursor: pointer; }
        h1 { color: #c800ff; }
        .build-card { border: 1px solid purple; margin: 10px 0; padding: 10px; border-radius: 8px; }
        .chat-message { border-bottom: 1px solid #333; padding: 5px; }
        a { color: #9f4dff; }
    </style>
</head>
<body>
    <h1>OXYX MARKET - FULL VERSION</h1>
    
    <!-- KEY SECTION -->
    <div class="box">
        <h3>üîê MOD KEY</h3>
        <input type="text" id="keyInput" placeholder="owner / mod1 / mod2">
        <button onclick="checkKey()">ACTIVATE</button>
        <p id="keyStatus"></p>
    </div>
    
    <!-- MOD SERVER -->
    <div id="modPanel" style="display:none;" class="box">
        <h3 style="color:gold;">üí¨ MOD SERVER</h3>
        <div id="chatBox" style="height:200px; overflow-y:auto; background:#0a0a1a; padding:10px; margin:10px 0;"></div>
        <input type="text" id="chatMsg" placeholder="Type message" style="width:70%;">
        <button onclick="sendChat()">SEND</button>
    </div>
    
    <!-- UPLOAD BUILD -->
    <div class="box">
        <h3>üì§ UPLOAD BUILD</h3>
        <input type="text" id="buildName" placeholder="Build name"><br>
        <input type="text" id="buildType" placeholder="Type (Ship/Plane/etc)"><br>
        <input type="number" id="buildPrice" placeholder="Price (min 100)" min="100" value="100"><br>
        <textarea id="buildDesc" rows="2" placeholder="Description"></textarea><br>
        <input type="file" id="buildFile" accept=".build"><br>
        <button onclick="publishBuild()">PUBLISH</button>
    </div>
    
    <!-- MARKETPLACE -->
    <div class="box">
        <h3>üè™ MARKETPLACE</h3>
        <div id="marketGrid"></div>
    </div>

    <script>
        // ============================================
        // SUPABASE CONFIG
        // ============================================
        const SUPABASE_URL = 'https://crbbdjmzybqvkjauqyxzj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyYmJkam16eWJxdmtqYXVxeXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMjI1MTAsImV4cCI6MjA4Nzc5ODUxMH0.qO0kfhyMYcXZkhDQJRWI7YOM35AqW1EEoRZG9GdKnws';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        // ============================================
        // VARIABLES
        // ============================================
        let isMod = false;
        let currentUser = '';
        
        // ============================================
        // KEY SYSTEM (YANG UDAH WORK)
        // ============================================
        function checkKey() {
            let key = document.getElementById('keyInput').value;
            let status = document.getElementById('keyStatus');
            
            if (key === 'owner' || key === 'mod1' || key === 'mod2') {
                isMod = true;
                currentUser = key;
                status.innerHTML = '‚úÖ KEY BENAR!';
                status.style.color = 'green';
                document.getElementById('modPanel').style.display = 'block';
                
                // Load chat setelah aktivasi
                loadChats();
            } else {
                status.innerHTML = '‚ùå KEY SALAH! Coba: owner, mod1, mod2';
                status.style.color = 'red';
            }
        }
        
        // ============================================
        // CHAT FUNCTIONS
        // ============================================
        async function loadChats() {
            const { data, error } = await supabase
                .from('chats')
                .select('*')
                .order('id', { ascending: true });
                
            if (error) {
                console.error('Error loading chats:', error);
                return;
            }
            
            let html = '';
            if (data && data.length > 0) {
                data.forEach(c => {
                    html += `<div class="chat-message">
                        <b>${c.user_name}:</b> ${c.message}
                    </div>`;
                });
            } else {
                html = '<p>Belum ada chat</p>';
            }
            document.getElementById('chatBox').innerHTML = html;
        }
        
        async function sendChat() {
            if (!isMod) {
                alert('Aktivasi dulu!');
                return;
            }
            
            let msg = document.getElementById('chatMsg').value;
            if (!msg) return;
            
            const { error } = await supabase
                .from('chats')
                .insert([{
                    user_name: currentUser,
                    message: msg
                }]);
                
            if (!error) {
                document.getElementById('chatMsg').value = '';
                loadChats();
            }
        }
        
        // ============================================
        // BUILD FUNCTIONS
        // ============================================
        async function loadBuilds() {
            const { data, error } = await supabase
                .from('builds')
                .select('*')
                .order('id', { ascending: false });
                
            if (error) {
                console.error('Error loading builds:', error);
                return;
            }
            
            let html = '';
            if (data && data.length > 0) {
                data.forEach(b => {
                    html += `<div class="build-card">
                        <b>${b.name}</b> (${b.type}) - ${b.price} Robux<br>
                        ${b.description || '-'}<br>
                        <small>File: ${b.file_name}</small><br>
                        ${b.file_url ? `<a href="${b.file_url}" download="${b.file_name}">‚¨áÔ∏è DOWNLOAD</a>` : ''}
                        <br><small>Seller: ${b.seller}</small>
                    </div>`;
                });
            } else {
                html = '<p>Belum ada build</p>';
            }
            document.getElementById('marketGrid').innerHTML = html;
        }
        
        async function publishBuild() {
            let name = document.getElementById('buildName').value;
            let type = document.getElementById('buildType').value;
            let price = document.getElementById('buildPrice').value;
            let desc = document.getElementById('buildDesc').value;
            let file = document.getElementById('buildFile').files[0];
            
            if (!name || !type || !price || !desc || !file) {
                alert('Semua harus diisi!');
                return;
            }
            
            if (!file.name.toLowerCase().endsWith('.build')) {
                alert('File harus .build!');
                return;
            }
            
            if (price < 100) {
                alert('Harga minimal 100 Robux!');
                return;
            }
            
            try {
                // Upload file
                const fileName = `${Date.now()}_${file.name}`;
                const { error: uploadError } = await supabase.storage
                    .from('build-files')
                    .upload(fileName, file);
                    
                if (uploadError) throw uploadError;
                
                // Dapatkan URL
                const { data: urlData } = supabase.storage
                    .from('build-files')
                    .getPublicUrl(fileName);
                
                // Simpan ke database
                const { error: dbError } = await supabase
                    .from('builds')
                    .insert([{
                        id: Date.now(),
                        name: name,
                        type: type,
                        price: parseInt(price),
                        description: desc,
                        file_name: file.name,
                        file_url: urlData.publicUrl,
                        seller: isMod ? currentUser : 'Guest'
                    }]);
                    
                if (dbError) throw dbError;
                
                alert('‚úÖ Build dipublish!');
                
                // Reset form
                document.getElementById('buildName').value = '';
                document.getElementById('buildType').value = '';
                document.getElementById('buildPrice').value = '100';
                document.getElementById('buildDesc').value = '';
                document.getElementById('buildFile').value = '';
                
                loadBuilds();
                
            } catch (error) {
                console.error('Error:', error);
                alert('‚ùå Gagal: ' + error.message);
            }
        }
        
        // ============================================
        // AUTO REFRESH
        // ============================================
        setInterval(loadChats, 3000);
        setInterval(loadBuilds, 5000);
        
        // ============================================
        // LOAD DATA AWAL
        // ============================================
        loadBuilds();
    </script>
</body>
</html>
