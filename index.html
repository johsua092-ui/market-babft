// ============================================
// OXYX MARKET - FIXED VERSION
// ============================================

// Key & Roles
const KEYS = {
    owner: "owner_oxyx_2026",
    mod1: "mod1_jawa_2026",
    mod2: "mod2_jawa_2026"
};

const ROLES = {
    owner: { name: "OXYX", avatar: "üëë", color: "gold" },
    mod1: { name: "MODERATOR 1", avatar: "üõ°Ô∏è", color: "#9f4dff" },
    mod2: { name: "MODERATOR 2", avatar: "‚öîÔ∏è", color: "#9f4dff" }
};

// Data Storage
let activeUsers = JSON.parse(localStorage.getItem('oxyxActiveUsers')) || {};
let chatMessages = JSON.parse(localStorage.getItem('oxyxChatMessages')) || [];
let transactions = JSON.parse(localStorage.getItem('oxyxModTransactions')) || [];
let builds = JSON.parse(localStorage.getItem('oxyxBuilds')) || [];

let currentUser = null;
let currentRole = null;

// ======= HWID =======
function generateHWID() {
    const components = [
        navigator.userAgent,
        navigator.language,
        screen.width,
        screen.height,
        screen.colorDepth,
        navigator.hardwareConcurrency,
        navigator.platform
    ].join('|');

    let hash = 0;
    for (let i = 0; i < components.length; i++) {
        const chr = components.charCodeAt(i);
        hash = ((hash << 5) - hash) + chr;
        hash |= 0;
    }
    return 'HWID-' + Math.abs(hash);
}

const currentHWID = generateHWID();

// ======= Check if already logged in =======
if (activeUsers[currentHWID]) {
    currentRole = activeUsers[currentHWID];
    currentUser = ROLES[currentRole];
    updateUIForLogin();
}

// ======= Activate Key =======
function activateKey(role) {
    const keyInput = document.getElementById(`${role}Key`).value;

    if (keyInput !== KEYS[role]) {
        showNotif('‚ùå Wrong key!', '#aa0000');
        return;
    }

    if (activeUsers[currentHWID] && activeUsers[currentHWID] !== role) {
        showNotif('‚ùå This device already has a different role!', '#aa0000');
        return;
    }

    // Check if role is used on other device
    let keyUsed = false;
    for (let hwid in activeUsers) {
        if (activeUsers[hwid] === role && hwid !== currentHWID) {
            keyUsed = true;
            break;
        }
    }

    if (keyUsed) {
        showNotif('‚ùå This key is already used on another device!', '#aa0000');
        return;
    }

    activeUsers[currentHWID] = role;
    localStorage.setItem('oxyxActiveUsers', JSON.stringify(activeUsers));

    document.getElementById(`${role}Status`).innerHTML = `‚úÖ Activated<br><small>${currentHWID.substring(0,16)}...</small>`;
    document.getElementById(`${role}Btn`).disabled = true;

    currentRole = role;
    currentUser = ROLES[role];

    updateUIForLogin();
    showNotif(`‚úÖ Activated as ${currentUser.name}!`, '#00aa00');
}

// ======= Update UI for logged-in mod =======
function updateUIForLogin() {
    document.getElementById('modServer').classList.add('active');
    document.getElementById('onlineStatus').innerHTML = 'üü¢ ONLINE';
    document.getElementById('onlineStatus').style.background = '#00aa00';
    document.getElementById('chatInput').disabled = false;
    document.getElementById('chatSend').disabled = false;

    displayChatMessages();
    displayTransactions();

    addChatMessage('SYSTEM', `${currentUser.avatar} ${currentUser.name} has joined the MOD SERVER`);
}

// ======= Chat =======
function addChatMessage(sender, text) {
    const timestamp = new Date().toLocaleTimeString();
    const message = { sender, text, time: timestamp };
    chatMessages.push(message);
    localStorage.setItem('oxyxChatMessages', JSON.stringify(chatMessages));
    displayChatMessages();
}

function displayChatMessages() {
    const container = document.getElementById('chatMessages');
    container.innerHTML = '';
    chatMessages.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'chat-message';
        div.innerHTML = `
            <div class="chat-sender">${msg.sender}</div>
            <div class="chat-text">${msg.text}</div>
            <div class="chat-time">${msg.time}</div>
        `;
        container.appendChild(div);
    });
    container.scrollTop = container.scrollHeight;
}

function sendChat() {
    if (!currentUser) {
        showNotif('‚ùå Activate your key first!', '#aa0000');
        return;
    }
    const input = document.getElementById('chatInput');
    const msg = input.value.trim();
    if (!msg) return;
    addChatMessage(currentUser.name, msg);
    input.value = '';
}

// ======= Transactions =======
function displayTransactions() {
    const container = document.getElementById('transactionList');
    container.innerHTML = '';
    if (transactions.length === 0) {
        container.innerHTML = '<div style="color:#666; text-align:center; padding:20px;">No transactions yet</div>';
        return;
    }
    transactions.forEach(tr => {
        const card = document.createElement('div');
        card.className = 'transaction-card';
        card.innerHTML = `
            <div class="transaction-header">
                <span>${tr.item}</span>
                <span>${tr.price} Robux</span>
            </div>
            <div>Buyer: ${tr.buyer}</div>
        `;
        container.appendChild(card);
    });
}

// ======= Marketplace / Publish Build =======
function publishBuild() {
    if (!currentUser) {
        showNotif('‚ùå Activate your key first!', '#aa0000');
        return;
    }

    const name = document.getElementById('buildName').value.trim();
    const type = document.getElementById('buildType').value;
    const price = document.getElementById('price').value;
    const desc = document.getElementById('buildDesc').value.trim();
    const file = document.getElementById('buildFile').files[0];

    if (!name || !type || !price || !desc || !file) {
        showNotif('‚ùå Please fill all fields!', '#aa0000');
        return;
    }

    const newBuild = {
        name, type, price, desc, fileName: file.name, seller: currentUser.name
    };

    builds.push(newBuild);
    localStorage.setItem('oxyxBuilds', JSON.stringify(builds));
    displayBuilds();
    showNotif('‚úÖ Build published!', '#00aa00');

    // Reset form
    document.getElementById('buildName').value = '';
    document.getElementById('buildType').value = '';
    document.getElementById('price').value = '100';
    document.getElementById('buildDesc').value = '';
    document.getElementById('buildFile').value = '';
}

function displayBuilds() {
    const grid = document.getElementById('buildGrid');
    grid.innerHTML = '';

    if (builds.length === 0) {
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:30px; color:#666;">üì¶ No builds yet</div>';
        return;
    }

    builds.forEach(b => {
        const card = document.createElement('div');
        card.className = 'build-card';
        card.innerHTML = `
            <div class="build-name">${b.name}</div>
            <div class="build-price">üí∞ ${b.price} Robux</div>
            <div class="build-seller">Seller: ${b.seller}</div>
            <div class="build-type">Type: ${b.type}</div>
            <div class="build-desc">${b.desc}</div>
        `;
        grid.appendChild(card);
    });
}

// ======= Notifications =======
function showNotif(text, color) {
    const notif = document.createElement('div');
    notif.className = 'notif';
    notif.style.background = color;
    notif.textContent = text;
    document.body.appendChild(notif);
    setTimeout(() => notif.remove(), 3000);
}

// ======= Init Display =======
displayBuilds();
displayChatMessages();
displayTransactions();
