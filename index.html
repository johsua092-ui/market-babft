<!DOCTYPE html>
<html>
<head>
    <title>OXYX MARKET - Private</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI',Arial,sans-serif; }
        body { background:#0a0a0a; color:white; padding:20px; }
        .container { max-width:1200px; margin:0 auto; }
        h1 { color:#b87cff; text-align:center; margin-bottom:30px; border-bottom:2px solid #9f4dff; padding-bottom:10px; }
        .card { background:#1a1a2a; border:2px solid #9f4dff; border-radius:10px; padding:20px; margin-bottom:20px; }
        .discord-links { display:flex; gap:10px; justify-content:center; margin:20px 0; flex-wrap:wrap; }
        .discord-links a { padding:10px 20px; background:#5865F2; color:white; text-decoration:none; border-radius:5px; }
        
        /* Layout Login Baru */
        #loginOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:#0a0a0a; display:flex; justify-content:center; align-items:center; z-index:9999; }
        .login-box { background:#1a1a2a; padding:40px; border:2px solid #9f4dff; border-radius:10px; text-align:center; box-shadow: 0 0 20px rgba(159, 77, 255, 0.3); }
        .github-btn { background:#333; color:white; padding:15px 30px; border:none; border-radius:5px; font-size:1.2em; cursor:pointer; margin-top:20px; font-weight:bold; }
        .github-btn:hover { background:#555; }
        
        .status { padding:10px; border-radius:5px; margin:10px 0; display:none; }
        .success { background:#1a3a1a; border:1px solid #00ff00; color:#00ff00; }
        .error { background:#3a1a1a; border:1px solid #ff0000; color:#ff0000; }
        .chat-box { background:#0a0a1a; border:2px solid #9f4dff; border-radius:5px; padding:15px; height:200px; overflow-y:auto; margin-bottom:15px; display:flex; flex-direction:column; }
        .chat-message { padding:8px; border-bottom:1px solid #333; width:100%; word-wrap: break-word; }
        .chat-message b { color:#b87cff; }
        .publish-btn { width:100%; padding:15px; background:#9f4dff; border:none; border-radius:5px; color:white; font-size:1.2em; cursor:pointer; margin-top:15px; }
        .sort-buttons { display:flex; gap:10px; margin:20px 0; }
        .sort-btn { flex:1; padding:12px; background:#2a2a3a; border:2px solid #9f4dff; border-radius:5px; color:white; cursor:pointer; }
        .sort-btn.active { background:#9f4dff; }
        .build-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:15px; }
        .build-card { background:#2a2a3a; border:2px solid #9f4dff; border-radius:5px; padding:15px; word-wrap: break-word;}
        .build-card.free { border-color:#00ff00; }
        .build-card.premium { border-color:gold; }
        .build-price { font-size:1.2em; font-weight:bold; margin:10px 0; }
        .free .build-price { color:#00ff00; }
        .premium .build-price { color:gold; }
        .download-btn { width:100%; padding:12px; margin-top:15px; background:#00aa00; border:none; border-radius:5px; color:white; font-weight:bold; cursor:pointer; font-size:1em; }
        .download-btn:hover { background:#00ff00; }
        .footer { text-align:center; color:#666; margin-top:30px; padding-top:20px; border-top:1px solid #333; }
        input, select, textarea { width:100%; padding:12px; margin:8px 0; background:#2a2a3a; border:2px solid #9f4dff; border-radius:5px; color:white; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <h1>‚ö° OXYX MARKET ‚ö°</h1>
        <p style="color:#aaa;">Private Access. Collaborators Only.</p>
        <button id="githubLoginBtn" class="github-btn">Log in with GitHub</button>
    </div>
</div>

<div id="mainApp" class="container" style="display:none;">
    <h1>‚ö° OXYX MARKET ‚ö°</h1>

    <div class="discord-links">
        <a href="https://discord.gg/autobuild" target="_blank">MAIN SERVER</a>
        <a href="https://discord.gg/boatbuilderhub" target="_blank">SUPPORT 1</a>
        <a href="https://discord.gg/boatbuilderhub" target="_blank">SUPPORT 2</a>
    </div>

    <div class="card">
        <h3>üí¨ DEVELOPER CHAT</h3>
        <div class="chat-box" id="chatMessages">Loading...</div>
        <div style="display:flex; gap:10px;">
            <input type="text" id="chatInput" placeholder="Type message..." style="flex:1;">
            <button onclick="window.sendChat()">SEND</button>
        </div>
    </div>

    <div class="card">
        <h3>üì§ UPLOAD BUILD</h3>
        <input type="text" id="buildName" placeholder="Build Name" maxlength="50">
        <select id="buildType">
            <option value="Ship">üö¢ Ship</option>
            <option value="Plane">‚úàÔ∏è Plane</option>
            <option value="Mech">ü§ñ Mech</option>
        </select>
        <input type="number" id="buildPrice" min="0" value="0" placeholder="Price (Robux)">
        <textarea id="buildDesc" rows="3" placeholder="Build description..." maxlength="200"></textarea>
        <input type="file" id="buildFile" accept=".build">
        <button class="publish-btn" onclick="window.publishBuild()">üöÄ PUBLISH BUILD</button>
        <div id="uploadStatus" class="status"></div>
    </div>

    <div class="sort-buttons">
        <button class="sort-btn active" onclick="window.filterBuilds('all', event)">üìã ALL</button>
        <button class="sort-btn" onclick="window.filterBuilds('free', event)">üÜì FREE (0)</button>
        <button class="sort-btn" onclick="window.filterBuilds('premium', event)">üíé PREMIUM (90-100)</button>
    </div>

    <div class="card">
        <h3>üè™ MARKETPLACE</h3>
        <div id="marketplace" class="build-grid">Loading...</div>
    </div>

    <div class="footer">OXYX MARKET ‚Ä¢ Private GitHub Authentication Active</div>
</div>

<script type="module">
    // 1. IMPORT FIREBASE (Versi 10)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getAuth, signInWithPopup, GithubAuthProvider, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    // --- üëá GANTI DENGAN CONFIG FIREBASE KAMU NANTI üëá ---
    const firebaseConfig = {
      apiKey: "ISI_NANTI",
      authDomain: "ISI_NANTI.firebaseapp.com",
      projectId: "ISI_NANTI",
      storageBucket: "ISI_NANTI.appspot.com",
      messagingSenderId: "ISI_NANTI",
      appId: "ISI_NANTI"
    };
    // -----------------------------------------------------

    // Inisialisasi Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const provider = new GithubAuthProvider();

    // --- üëá DAFTAR USERNAME GITHUB YANG DIIZINKAN MASUK üëá ---
    const ALLOWED_USERS = ["johsua092-ui", "anindyakurniaputri2077-del", "teman2"];

    // Variabel Global
    window.isMod = false;
    window.currentUser = '';
    
    // Konfigurasi Database Lama (JSONBin)
    const API_KEY = '$2a$10$RYz0R2fKkR23Gf1qGguLi.5Tlr.5UlfHymp1bYXB5Zhp352m4fdua';
    const BIN_ID = '69a24d2a43b1c97be9a53651';
    const API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;
    let builds=[], chats=[], currentFilter='all';

    // 2. SISTEM LOGIN GITHUB
    document.getElementById('githubLoginBtn').addEventListener('click', () => {
        signInWithPopup(auth, provider).then((result) => {
            // Ambil username GitHub (screenName)
            const username = result._tokenResponse.screenName;
            
            if (ALLOWED_USERS.includes(username)) {
                // Berhasil & Diizinkan
                window.currentUser = username;
                window.isMod = true;
                
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                // Baru load data database setelah sukses masuk
                loadData();
                setInterval(loadData, 3000); // Auto-refresh tiap 3 detik
            } else {
                // Ditolak
                alert(`Akses Ditolak! Username GitHub '${username}' tidak terdaftar dalam tim OXYX.`);
                signOut(auth);
            }
        }).catch((error) => {
            console.error("Login Gagal:", error);
            alert("Terjadi kesalahan saat login GitHub.");
        });
    });

    // ==========================================
    // SISA KODE LAMA YANG SUDAH DIPERBAIKI (JSONBin & XSS)
    // ==========================================

    function escapeHTML(str) {
        if (!str) return '';
        return str.replace(/[&<>'"]/g, tag => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', "'": '&#39;', '"': '&quot;'
        }[tag] || tag));
    }

    async function loadData() {
        if(!window.isMod) return; // Jangan load jika belum login
        try {
            const res = await fetch(API_URL + '/latest', { headers:{ 'X-Access-Key':API_KEY }});
            const data = await res.json();
            builds = data.record.builds || [];
            chats = data.record.chats || [];
            displayBuilds();
            displayChats();
        } catch(e){console.error(e);}
    }

    async function saveData(){
        try {
            await fetch(API_URL,{method:'PUT', headers:{'Content-Type':'application/json','X-Access-Key':API_KEY}, body:JSON.stringify({builds,chats})});
            return true;
        } catch(e){console.error(e); return false;}
    }

    function showStatus(id,msg,type){
        const el=document.getElementById(id);
        el.style.display='block'; el.className='status '+type; el.textContent=msg;
        setTimeout(()=>el.style.display='none',3000);
    }

    function displayChats(){
        const box=document.getElementById('chatMessages');
        if(!box) return;
        let html='';
        if(chats.length===0){
            html='<p style="color:#666;">No messages yet</p>';
        } else {
            chats.forEach(c => {
                html+=`<div class="chat-message"><b>${escapeHTML(c.user)}:</b> ${escapeHTML(c.msg)}</div>`;
            });
        }
        box.innerHTML=html;
        box.scrollTop = box.scrollHeight;
    }

    window.sendChat = async function(){
        const msg=document.getElementById('chatInput').value.trim();
        if(!msg) return;
        
        chats.push({user:window.currentUser,msg,time:new Date().toLocaleTimeString()});
        
        if(await saveData()){ 
            document.getElementById('chatInput').value=''; 
            await loadData();
        } else alert('‚ùå Failed to send message');
    }

    window.publishBuild = async function(){
        const name=document.getElementById('buildName').value.trim();
        const type=document.getElementById('buildType').value;
        const price=parseInt(document.getElementById('buildPrice').value);
        const desc=document.getElementById('buildDesc').value.trim();
        const fileInput=document.getElementById('buildFile');
        
        if(!name||!type||!desc||!fileInput.files[0]) { alert('Fill all fields!'); return; }
        const file=fileInput.files[0];
        if(!file.name.toLowerCase().endsWith('.build')){ alert('File must be .build!'); return; }

        showStatus('uploadStatus','‚è´ Uploading...', 'success');

        const reader = new FileReader();
        reader.onload = async function(e) {
            builds.push({
                id: Date.now(),
                name, type, price, desc,
                fileName: file.name,
                fileData: e.target.result,
                seller: window.currentUser
            });
            
            if(await saveData()){
                document.getElementById('buildName').value='';
                document.getElementById('buildPrice').value='0';
                document.getElementById('buildDesc').value='';
                document.getElementById('buildFile').value='';
                showStatus('uploadStatus','‚úÖ Build published successfully!','success');
                await loadData();
            } else showStatus('uploadStatus','‚ùå Failed to publish','error');
        };
        reader.readAsDataURL(file);
    }

    window.triggerDownload = function(id) {
        const build = builds.find(b => b.id === id);
        if (build) {
            if (!build.fileData) { alert('‚ùå File not available!'); return; }
            try {
                const link=document.createElement('a'); 
                link.href=build.fileData; 
                link.download=build.fileName;
                document.body.appendChild(link); 
                link.click();
                setTimeout(()=>document.body.removeChild(link),1000);
            } catch (error) { alert('‚ùå Download failed: ' + error.message); }
        } else {
            alert('‚ùå Build not found!');
        }
    }

    window.filterBuilds = function(filter,evt){
        currentFilter=filter;
        document.querySelectorAll('.sort-btn').forEach(btn=>btn.classList.remove('active'));
        if(evt) evt.currentTarget.classList.add('active');
        displayBuilds();
    }

    function displayBuilds(){
        const grid=document.getElementById('marketplace');
        let filtered=builds;
        if(currentFilter==='free') filtered=builds.filter(b=>b.price===0);
        if(currentFilter==='premium') filtered=builds.filter(b=>b.price>=90&&b.price<=100);
        
        if(filtered.length===0){ grid.innerHTML='<p style="text-align:center;color:#666;">No builds available</p>'; return;}
        
        let html='';
        filtered.slice().reverse().forEach(b=>{
            const isFree=b.price===0; 
            const isPremium=b.price>=90&&b.price<=100;
            let cardClass=isFree?'free':(isPremium?'premium':'');
            
            html+=`<div class="build-card ${cardClass}">
                <h3>${escapeHTML(b.name)}</h3><div>${escapeHTML(b.type)}</div>
                <div class="build-price">üí∞ ${b.price} Robux</div>
                <p>${escapeHTML(b.desc)}</p>
                <div style="margin-top:10px;"><small>Seller: ${escapeHTML(b.seller)}</small></div>
                ${b.fileData ? `<button class="download-btn" onclick="window.triggerDownload(${b.id})">‚¨áÔ∏è DOWNLOAD ${escapeHTML(b.fileName)}</button>` : ''}
            </div>`;
        });
        grid.innerHTML=html;
    }
</script>
</body>
</html>
