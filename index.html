<!DOCTYPE html>
<html>
<head>
    <title>OXYX Market</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { background: black; color: white; font-family: Arial; padding: 20px; }
        .box { background: #1a1a2a; border: 2px solid purple; border-radius: 10px; padding: 15px; margin: 10px; }
        button { background: purple; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; }
        input, textarea { width: 100%; padding: 8px; margin: 5px 0; background: #333; color: white; border: 1px solid purple; }
    </style>
</head>
<body>
    <h1>OXYX MARKET</h1>
    
    <div class="box">
        <h3>üîê MOD KEY</h3>
        <input type="text" id="keyInput" placeholder="owner / mod1 / mod2">
        <button onclick="checkKey()">ACTIVATE</button>
        <p id="keyStatus"></p>
    </div>

    <div id="modPanel" style="display:none;" class="box">
        <h3>üí¨ MOD CHAT</h3>
        <div id="chatBox" style="height:150px; overflow:auto; background:#0a0a1a; padding:10px;"></div>
        <input type="text" id="chatMsg" placeholder="Message">
        <button onclick="sendChat()">SEND</button>
    </div>

    <div class="box">
        <h3>üì§ UPLOAD BUILD</h3>
        <input type="text" id="buildName" placeholder="Name">
        <input type="text" id="buildType" placeholder="Type">
        <input type="number" id="buildPrice" placeholder="Price" value="100">
        <textarea id="buildDesc" placeholder="Description"></textarea>
        <input type="file" id="buildFile" accept=".build">
        <button onclick="publishBuild()">PUBLISH</button>
    </div>

    <div class="box">
        <h3>üè™ MARKETPLACE</h3>
        <div id="marketGrid"></div>
    </div>

    <script>
        const SUPABASE_URL = 'https://crbbdjmzybqvkjauqyxzj.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNyYmJkam16eWJxdmtqYXVxeXpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIyMjI1MTAsImV4cCI6MjA4Nzc5ODUxMH0.qO0kfhyMYcXZkhDQJRWI7YOM35AqW1EEoRZG9GdKnws';
        
        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let isMod = false;
        let currentUser = '';

        async function loadBuilds() {
            const { data } = await supabase.from('builds').select('*');
            let html = '';
            if (data && data.length) {
                data.forEach(b => {
                    html += `<div style="border:1px solid purple; margin:10px; padding:10px;">
                        <b>${b.name}</b> (${b.type}) - ${b.price} Robux<br>
                        ${b.description}<br>
                        File: ${b.file_name}<br>
                        ${b.file_url ? `<a href="${b.file_url}" download>DOWNLOAD</a>` : ''}
                        <br><small>Seller: ${b.seller}</small>
                    </div>`;
                });
            } else {
                html = '<p>Belum ada build</p>';
            }
            document.getElementById('marketGrid').innerHTML = html;
        }

        async function loadChats() {
            const { data } = await supabase.from('chats').select('*');
            let html = '';
            if (data && data.length) {
                data.forEach(c => {
                    html += `<div><b>${c.user_name}:</b> ${c.message}</div>`;
                });
            }
            document.getElementById('chatBox').innerHTML = html;
        }

        async function publishBuild() {
            let name = document.getElementById('buildName').value;
            let type = document.getElementById('buildType').value;
            let price = document.getElementById('buildPrice').value;
            let desc = document.getElementById('buildDesc').value;
            let file = document.getElementById('buildFile').files[0];

            if (!name || !type || !price || !desc || !file) {
                alert('Isi semua!');
                return;
            }

            const fileName = Date.now() + '_' + file.name;
            const { error: uploadError } = await supabase.storage
                .from('build-files')
                .upload(fileName, file);

            if (uploadError) {
                alert('Gagal upload: ' + uploadError.message);
                return;
            }

            const { data: urlData } = supabase.storage
                .from('build-files')
                .getPublicUrl(fileName);

            const { error: dbError } = await supabase
                .from('builds')
                .insert([{
                    id: Date.now(),
                    name, type,
                    price: parseInt(price),
                    description: desc,
                    file_name: file.name,
                    file_url: urlData.publicUrl,
                    seller: isMod ? currentUser : 'Guest'
                }]);

            if (dbError) {
                alert('Gagal simpan: ' + dbError.message);
            } else {
                alert('Berhasil publish!');
                loadBuilds();
            }
        }

        async function sendChat() {
            if (!isMod) return alert('Aktivasi dulu!');
            let msg = document.getElementById('chatMsg').value;
            if (!msg) return;
            
            await supabase.from('chats').insert([{
                user_name: currentUser,
                message: msg
            }]);
            
            document.getElementById('chatMsg').value = '';
            loadChats();
        }

        function checkKey() {
            let key = document.getElementById('keyInput').value;
            if (key === 'owner' || key === 'mod1' || key === 'mod2') {
                isMod = true;
                currentUser = key;
                document.getElementById('modPanel').style.display = 'block';
                document.getElementById('keyStatus').innerHTML = '‚úÖ Activated';
            } else {
                alert('Key salah!');
            }
        }

        loadBuilds();
        loadChats();
        setInterval(loadChats, 3000);
    </script>
</body>
</html>
